// Schema Prisma - TrafficPro SaaS Multi-Tenant
// Banco de dados: PostgreSQL (Supabase)

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ==========================================
// PLANOS E ASSINATURAS
// ==========================================

model Plan {
  id          String   @id @default(cuid())
  name        String   // Starter, Pro, Enterprise
  slug        String   @unique // starter, pro, enterprise
  description String?

  // Precos
  priceMonthly  Float
  priceYearly   Float
  currency      String  @default("BRL")

  // Limites
  maxUsers           Int     @default(1)
  maxCampaigns       Int     @default(10)
  maxLeads           Int     @default(500)
  maxIntegrations    Int     @default(2)
  maxCreatives       Int     @default(100)
  maxWhatsappNumbers Int     @default(1)

  // Features
  hasAiAnalysis      Boolean @default(false)
  hasAdvancedReports Boolean @default(false)
  hasAutomation      Boolean @default(false)
  hasApiAccess       Boolean @default(false)
  hasPrioritySupport Boolean @default(false)
  hasWhiteLabel      Boolean @default(false)

  // Meta
  isActive    Boolean  @default(true)
  isFeatured  Boolean  @default(false)
  sortOrder   Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relacoes
  organizations Organization[]

  @@map("plans")
}

// ==========================================
// ORGANIZACOES (MULTI-TENANT)
// ==========================================

model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique // URL amigavel
  logo        String?
  website     String?

  // Plano e Assinatura
  planId              String
  plan                Plan     @relation(fields: [planId], references: [id])
  subscriptionStatus  SubscriptionStatus @default(TRIALING)
  trialEndsAt         DateTime?
  subscriptionEndsAt  DateTime?
  stripeCustomerId    String?  @unique
  stripeSubscriptionId String?

  // Configuracoes
  timezone    String   @default("America/Sao_Paulo")
  language    String   @default("pt-BR")

  // Meta
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relacoes
  members       OrganizationMember[]
  integrations  Integration[]
  campaigns     Campaign[]
  leads         Lead[]
  conversations Conversation[]
  creatives     Creative[]
  artTemplates  ArtTemplateSaved[]
  webhooks      Webhook[]
  apiKeys       ApiKey[]
  auditLogs     AuditLog[]

  @@map("organizations")
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
  INCOMPLETE
}

// ==========================================
// USUARIOS E MEMBROS
// ==========================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  passwordHash  String?

  // Perfil
  name          String?
  avatar        String?
  phone         String?

  // Meta
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relacoes
  memberships   OrganizationMember[]
  accounts      Account[]
  sessions      Session[]

  @@map("users")
}

model OrganizationMember {
  id             String   @id @default(cuid())

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  role           MemberRole @default(MEMBER)

  // Permissoes granulares
  canManageCampaigns    Boolean @default(true)
  canManageLeads        Boolean @default(true)
  canManageIntegrations Boolean @default(false)
  canManageBilling      Boolean @default(false)
  canManageMembers      Boolean @default(false)
  canViewReports        Boolean @default(true)

  // Meta
  invitedAt     DateTime @default(now())
  acceptedAt    DateTime?
  isActive      Boolean  @default(true)

  @@unique([organizationId, userId])
  @@map("organization_members")
}

enum MemberRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

// NextAuth - Accounts (OAuth)
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

// NextAuth - Sessions
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ==========================================
// INTEGRACOES (TOKENS CRIPTOGRAFADOS)
// ==========================================

model Integration {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  platform       IntegrationPlatform
  name           String   // Nome amigavel dado pelo usuario

  // Credenciais (CRIPTOGRAFADAS)
  accessToken    String   @db.Text // Criptografado AES-256
  refreshToken   String?  @db.Text // Criptografado AES-256
  tokenExpiresAt DateTime?

  // IDs da plataforma
  platformAccountId   String?  // ID da conta na plataforma
  platformAccountName String?  // Nome da conta na plataforma

  // WhatsApp especifico
  whatsappPhoneNumber String?
  whatsappPhoneId     String?

  // Status
  status         IntegrationStatus @default(PENDING)
  lastSyncAt     DateTime?
  lastErrorAt    DateTime?
  lastError      String?

  // Meta
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relacoes
  campaigns      Campaign[]
  adAccounts     AdAccount[]
  conversations  Conversation[]

  @@unique([organizationId, platform, platformAccountId])
  @@map("integrations")
}

enum IntegrationPlatform {
  META
  GOOGLE
  TIKTOK
  LINKEDIN
  WHATSAPP
  TWITTER
}

enum IntegrationStatus {
  PENDING
  CONNECTED
  ERROR
  EXPIRED
  DISCONNECTED
}

model AdAccount {
  id             String   @id @default(cuid())
  integrationId  String
  integration    Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  platformAdAccountId String
  name                String
  currency            String  @default("BRL")
  timezone            String?

  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  campaigns      Campaign[]

  @@unique([integrationId, platformAdAccountId])
  @@map("ad_accounts")
}

// ==========================================
// CAMPANHAS
// ==========================================

model Campaign {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  integrationId  String?
  integration    Integration? @relation(fields: [integrationId], references: [id])

  adAccountId    String?
  adAccount      AdAccount? @relation(fields: [adAccountId], references: [id])

  // Identificadores da plataforma
  platformCampaignId String?

  // Dados basicos
  name           String
  objective      CampaignObjective
  status         CampaignStatus @default(DRAFT)
  platform       IntegrationPlatform

  // Orcamento
  budget         Float
  budgetType     BudgetType @default(DAILY)
  spent          Float      @default(0)

  // Datas
  startDate      DateTime?
  endDate        DateTime?

  // Meta
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  lastSyncAt     DateTime?

  // Relacoes
  metrics        CampaignMetrics[]
  dailyMetrics   CampaignDailyMetrics[]
  leads          Lead[]

  @@unique([organizationId, platformCampaignId])
  @@index([organizationId, status])
  @@index([organizationId, platform])
  @@map("campaigns")
}

enum CampaignObjective {
  AWARENESS
  TRAFFIC
  ENGAGEMENT
  LEADS
  SALES
  APP_INSTALLS
  VIDEO_VIEWS
  MESSAGES
  CONVERSIONS
}

enum CampaignStatus {
  DRAFT
  PENDING
  ACTIVE
  PAUSED
  ENDED
  ERROR
  ARCHIVED
}

enum BudgetType {
  DAILY
  LIFETIME
}

model CampaignMetrics {
  id          String   @id @default(cuid())
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  // Metricas agregadas (totais)
  impressions     Int      @default(0)
  reach           Int      @default(0)
  clicks          Int      @default(0)
  ctr             Float    @default(0)
  cpc             Float    @default(0)
  cpm             Float    @default(0)
  conversions     Int      @default(0)
  conversionRate  Float    @default(0)
  costPerConversion Float  @default(0)
  spent           Float    @default(0)
  roas            Float    @default(0)
  frequency       Float    @default(0)

  // Video
  videoViews          Int    @default(0)
  videoViewsP25       Int    @default(0)
  videoViewsP50       Int    @default(0)
  videoViewsP75       Int    @default(0)
  videoViewsP100      Int    @default(0)
  videoCompletionRate Float  @default(0)

  // Engajamento
  likes       Int @default(0)
  comments    Int @default(0)
  shares      Int @default(0)
  saves       Int @default(0)

  // Periodo
  periodStart DateTime
  periodEnd   DateTime

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([campaignId, periodStart, periodEnd])
  @@map("campaign_metrics")
}

model CampaignDailyMetrics {
  id          String   @id @default(cuid())
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  date        DateTime @db.Date

  impressions     Int      @default(0)
  reach           Int      @default(0)
  clicks          Int      @default(0)
  ctr             Float    @default(0)
  cpc             Float    @default(0)
  cpm             Float    @default(0)
  conversions     Int      @default(0)
  spent           Float    @default(0)
  roas            Float    @default(0)

  createdAt   DateTime @default(now())

  @@unique([campaignId, date])
  @@index([campaignId, date])
  @@map("campaign_daily_metrics")
}

// ==========================================
// CRM - LEADS E FUNIL
// ==========================================

model Lead {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  campaignId     String?
  campaign       Campaign? @relation(fields: [campaignId], references: [id])

  // Dados do lead
  name           String
  email          String?
  phone          String?

  // Origem
  source         LeadSource
  sourceDetails  String?  // Ex: nome da campanha, formulario
  utmSource      String?
  utmMedium      String?
  utmCampaign    String?
  utmContent     String?
  utmTerm        String?

  // Funil
  status         LeadStatus @default(NEW)
  value          Float?     // Valor potencial do negocio

  // Atribuicao
  assignedToId   String?    // ID do membro responsavel

  // Notas e dados extras
  notes          String?    @db.Text
  customFields   Json?      // Campos personalizados

  // Meta
  convertedAt    DateTime?
  lostAt         DateTime?
  lostReason     String?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relacoes
  history        LeadHistory[]
  conversations  Conversation[]

  @@index([organizationId, status])
  @@index([organizationId, source])
  @@index([phone])
  @@index([email])
  @@map("leads")
}

enum LeadSource {
  META_ADS
  GOOGLE_ADS
  TIKTOK_ADS
  LINKEDIN_ADS
  WHATSAPP
  ORGANIC
  REFERRAL
  WEBSITE
  MANUAL
  OTHER
}

enum LeadStatus {
  NEW           // Novo lead
  CONTACTED     // Em andamento - Primeiro contato feito
  QUALIFIED     // Em andamento - Lead qualificado
  PROPOSAL      // Em andamento - Proposta enviada
  NEGOTIATION   // Em andamento - Em negociacao
  WON           // Concluido - Venda realizada
  LOST          // Descartado - Perdido
  REMARKETING   // Remarketing - Retomou contato
}

model LeadHistory {
  id          String     @id @default(cuid())
  leadId      String
  lead        Lead       @relation(fields: [leadId], references: [id], onDelete: Cascade)

  fromStatus  LeadStatus?
  toStatus    LeadStatus
  note        String?
  changedById String?    // ID do usuario que fez a mudanca

  createdAt   DateTime   @default(now())

  @@index([leadId, createdAt])
  @@map("lead_history")
}

// ==========================================
// CRM - CONVERSAS (WHATSAPP)
// ==========================================

model Conversation {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  integrationId  String
  integration    Integration @relation(fields: [integrationId], references: [id])

  leadId         String?
  lead           Lead?    @relation(fields: [leadId], references: [id])

  // Identificador externo
  platformConversationId String?

  // Contato
  contactName    String
  contactPhone   String
  contactAvatar  String?

  // Status
  status         ConversationStatus @default(OPEN)
  unreadCount    Int      @default(0)

  // Ultima mensagem
  lastMessageAt     DateTime?
  lastMessagePreview String?

  // Atribuicao
  assignedToId   String?

  // Meta
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relacoes
  messages       Message[]

  @@unique([organizationId, integrationId, contactPhone])
  @@index([organizationId, status])
  @@map("conversations")
}

enum ConversationStatus {
  OPEN
  PENDING
  RESOLVED
  ARCHIVED
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  // Identificador externo
  platformMessageId String?

  // Conteudo
  content        String   @db.Text
  type           MessageType @default(TEXT)
  mediaUrl       String?

  // Direcao
  direction      MessageDirection

  // Status (para mensagens enviadas)
  status         MessageStatus @default(SENT)

  // Sender
  senderName     String?
  senderId       String?  // ID do membro que enviou (se direction = OUTBOUND)

  createdAt      DateTime @default(now())

  @@index([conversationId, createdAt])
  @@map("messages")
}

enum MessageType {
  TEXT
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
  LOCATION
  CONTACT
  STICKER
  TEMPLATE
}

enum MessageDirection {
  INBOUND   // Recebida do cliente
  OUTBOUND  // Enviada para o cliente
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
}

// ==========================================
// CRIATIVOS
// ==========================================

model Creative {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Dados basicos
  title          String
  description    String?

  // Tipo
  type           CreativeType
  platform       IntegrationPlatform?

  // Arquivos
  thumbnailUrl   String?
  mediaUrl       String?

  // Origem (se minerado)
  sourceUrl      String?
  sourceAdvertiser String?

  // Engajamento (se minerado)
  likes          Int?
  comments       Int?
  shares         Int?

  // Tags e organizacao
  tags           String[]
  folderId       String?

  // Meta
  isFavorite     Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organizationId, type])
  @@map("creatives")
}

enum CreativeType {
  IMAGE
  VIDEO
  CAROUSEL
  TEXT
}

model ArtTemplateSaved {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Template original
  templateId     String   // ID do template global

  // Customizacoes
  customName     String?
  customizations Json?

  createdAt      DateTime @default(now())

  @@unique([organizationId, templateId])
  @@map("art_templates_saved")
}

// ==========================================
// TEMPLATES DE ARTES (GLOBAL - NAO POR ORG)
// ==========================================

model ArtTemplate {
  id          String   @id @default(cuid())

  name        String
  description String?
  niche       String   // ecommerce, infoproduto, etc
  type        String   // feed, stories, reels, etc

  // Canva
  canvaUrl    String
  thumbnailUrl String?

  // Stats
  downloads   Int      @default(0)
  rating      Float    @default(0)
  ratingCount Int      @default(0)

  // Tags
  tags        String[]

  // Flags
  isNew       Boolean  @default(false)
  isPremium   Boolean  @default(false)
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([niche])
  @@index([type])
  @@map("art_templates")
}

// ==========================================
// WEBHOOKS E API KEYS
// ==========================================

model Webhook {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  url            String
  events         String[] // lead.created, campaign.updated, etc
  secret         String   // Para validacao HMAC

  isActive       Boolean  @default(true)
  lastTriggeredAt DateTime?
  failureCount   Int      @default(0)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("webhooks")
}

model ApiKey {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name           String
  keyHash        String   @unique // Hash da chave (a chave real so e mostrada 1 vez)
  keyPrefix      String   // Primeiros caracteres para identificacao

  permissions    String[] // read:campaigns, write:leads, etc

  lastUsedAt     DateTime?
  expiresAt      DateTime?
  isActive       Boolean  @default(true)

  createdAt      DateTime @default(now())

  @@map("api_keys")
}

// ==========================================
// AUDITORIA
// ==========================================

model AuditLog {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  userId         String?
  userEmail      String?

  action         String   // user.login, campaign.created, lead.status_changed
  entity         String?  // campaign, lead, integration
  entityId       String?

  oldData        Json?
  newData        Json?

  ipAddress      String?
  userAgent      String?

  createdAt      DateTime @default(now())

  @@index([organizationId, createdAt])
  @@index([organizationId, action])
  @@map("audit_logs")
}
